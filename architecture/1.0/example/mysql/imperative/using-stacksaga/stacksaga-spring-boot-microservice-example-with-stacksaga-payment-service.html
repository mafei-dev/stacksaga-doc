<!DOCTYPE html>
<html lang="en">
<head>
    <title>Stacksaga spring boot microservice example with stacksaga - Stack SAGA</title>

    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="Stack SAGA Quick Start with spring boot microservice.">
    <meta name="author" content="Mafei">


    <link type="image/png" sizes="16x16" rel="stacksaga-icon" href="./../../../../../../stacksaga-16.png">
    <link type="image/png" sizes="32x32" rel="stacksaga-icon" href="./../../../../../../stacksaga-32.png">
    <link type="image/png" sizes="96x96" rel="stacksaga-icon" href="./../../../../../../stacksaga-96.png">
    <meta name="stacksaga-TileColor" content="#da532c">
    <meta name="theme-color" content="#28b76b">


    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet">

    <!-- FontAwesome JS-->
    <script defer src="../../../../../../assets/fontawesome/js/all.min.js"></script>

    <!-- Plugins CSS -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.2/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="../../../../../../assets/plugins/simplelightbox/simple-lightbox.min.css">

    <!-- Theme CSS -->
    <link id="theme-style" rel="stylesheet" href="../../../../../../assets/css/theme.css">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LC0M1Q19EK"></script>
    <link rel="stylesheet" href="../../../../../../assets/css/custom.css">

    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-LC0M1Q19EK');
    </script>

</head>
<body class="docs-page">
<header class="header fixed-top">
    <div class="branding docs-branding">
        <div class="container-fluid position-relative py-2">
            <div class="docs-logo-wrapper">
                <button id="docs-sidebar-toggler" class="docs-sidebar-toggler docs-sidebar-visible me-2 d-xl-none"
                        type="button">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div class="site-logo">
                    <a class="navbar-brand" href="../../../../../../index.html">
                        <img src="../../../../../../assets/images/StackSagaIcon.png"
                             alt="logo"/>
                        <span class="logo-text">Stack<span class="text-alt">SAGA</span></span>
                    </a>
                </div>
            </div><!--//docs-logo-wrapper-->
            <div class="docs-top-utilities d-flex justify-content-end align-items-center">
                <div class="top-search-box d-none d-lg-flex">
                    <form class="search-form">
                        <input type="text" placeholder="Search the docs..." name="search"
                               class="form-control search-input">
                        <button type="submit" class="btn search-btn" value="Search"><i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>

                <ul class="social-list list-inline mx-md-3 mx-lg-5 mb-0 d-none d-lg-flex">
                    <li class="list-inline-item"><a href="https://github.com/stacksaga"><i
                            class="fab fa-github fa-fw"></i></a></li>
                    <li class="list-inline-item"><a href="https://stackoverflow.com/questions/tagged/stacksaga"><i
                            class="fab fa-stack-overflow fa-fw"></i></a></li>

                </ul><!--//social-list-->

            </div><!--//docs-top-utilities-->
        </div><!--//container-->
    </div><!--//branding-->
</header><!--//header-->
<div class="docs-wrapper">
    <div id="docs-sidebar" class="docs-sidebar">
        <div class="top-search-box d-lg-none p-3">
            <form class="search-form">
                <input type="text" placeholder="Search the docs..." name="search" class="form-control search-input">
                <button type="submit" class="btn search-btn" value="Search"><i class="fas fa-search"></i></button>
            </form>
        </div>
        <nav id="docs-nav" class="docs-nav navbar">
            <ul class="section-items list-unstyled nav flex-column pb-3">
                <li class="nav-item section-title"><a class="nav-link scrollto active" href="#section-1"><span
                        class="theme-icon-holder me-2"><i class="fas fa-map-signs"></i></span>Migration to SAGA</a></li>



                <li class="nav-item"><a class="nav-link scrollto" href="#adding-stacksaga-dependencies">Adding StackSaga
                    dependencies</a>
                </li>

                <li class="nav-item"><a class="nav-link scrollto" href="#updating-customerpaymentrepository">Updating
                    CustomerPaymentRepository</a>
                </li>
                <li class="nav-item"><a class="nav-link scrollto" href="#updating-customerpaymentservice">Updating
                    CustomerPaymentService</a>
                </li>

                <li class="nav-item"><a class="nav-link scrollto" href="#creating-makepaymentrevertrequestbody">Creating
                    MakePaymentRevertRequestBody</a>
                </li>

                <li class="nav-item"><a class="nav-link scrollto" href="#updating-customerpaymentcontroller">Updating
                    CustomerPaymentController</a>
                </li>


            </ul>

        </nav><!--//docs-nav-->
    </div><!--//docs-sidebar-->

    <div class="docs-content">
        <div class="container">
            <article class="docs-article" id="section-1">

                <header class="docs-header">

                    <h1 class="docs-heading">payment-service - migration to SAGA</h1>
                    <section>
                        <p id="adding-stacksaga-dependencies">
                            In one of past few sessions we have done our payment-service without moving to the Saga
                            design
                            pattern. now we are going to use that service to migrate to Saga design pattern by using
                            StackSaga. now you know that when the order-service migrates to the StackSaga in the
                            previous session, one additional method was created apart from the default method to invoke
                            the compensation-transaction. in that method called an API from the payment-service. that's
                            what we are going to implement here.
                        </p>

                        <div class="callout-block callout-block-info">

                            <div class="content">
                                <h4 class="callout-title">
                                                    <span class="callout-icon-holder me-1">
                                                        <i class="fas fa-info-circle"></i>
                                                    </span>
                                    Note
                                </h4>

                                <p>
                                    Adding StackSaga dependencies is not required in this application. but, in terms of
                                    Real-time circuit breaker pattern, it would be better if you add StackSaga
                                    dependencies in to each services. if you don't add the framework into the service,
                                    Real-time circuit breaker is not used. to get full features of the framework, you
                                    can use the dependencies in each application. to see how it works <a target="_blank"
                                                                                                         href="./../../../../topics/circuit-breaker.html">please
                                    refer this</a>.
                                </p>

                                <p>
                                    If you add the dependencies into the application, you have to add 2 dependencies.
                                    1st one is the core-dependency. it is required. and 2nd
                                    one is the implementation of the database accessing dependency. you can choose it as
                                    per your requirement. if you are willing to use Mysql database as your event-store,
                                    you can use stack-saga-spring-boot-starter-mysql dependency, or if you are willing
                                    to use MongoDb as your event-store, you can use stack-saga-spring-boot-starter-mongo
                                    dependency. <a href="./../../../../reference/dependencies.html">See more</a>
                                    available implementation dependencies. in this example, we use
                                    Mysql database as the event-store database.
                                </p>


                                <small>
                                    <span class="badge bg-primary">Updated</span>
                                    <b>payment-service >
                                        pom.xml
                                    </b>
                                </small>


                                <script src="https://gist.github.com/mafei-dev/9a13b74b48a7a8b13b2b46b6d9cee865.js"></script>

                                <br>
                                <br>
                                <p>
                                    If you have added StackSaga in your application, you have to configure the
                                    properties for StackSaga. you can see below the configurations are done. in you want
                                    to get the idea for each configuration properties please refer the <a
                                        href="./../../../../reference/configuration-properties.html">configuration
                                    reference</a>.
                                </p>
                                <br>

                                <small>
                                    <span class="badge bg-primary">Updated</span>
                                    <b>payment-service > application.yml
                                    </b>
                                </small>
                                <script src="https://gist.github.com/mafei-dev/924e452b0322634230013e00a9881a2a.js"></script>
                                <br>
                                <br>

                                <p>
                                    If you have added StackSaga in your application, after changing the properties, you
                                    have to annotate the application as <code>
                                    @EnableStackSaga
                                </code>. and after that you can see that some AutoConfiguration classes are excluded.
                                    the reason is that the framework uses the
                                    <code>spring-boot-starter-data-redis</code> dependency and
                                    <code>liquibase-core</code> dependency in order to have that features. but the
                                    framework doesn't use the default configuration that the dependencies provide for
                                    you.
                                    because the stackSaga use its own configuration to access those features by using
                                    that dependencies. but in the application, you might want to use those dependencies
                                    in your application for your wants. you can use those default configurations as
                                    you want. if stackSaga have used those default configurations for their execution,
                                    as a developer, you have to configure those configurations by spending some time. it
                                    will be bothered to you. therefore, if you are not going to use <b>Redis</b> and <b>liquibase</b>
                                    features for your application, the autoconfiguration class should be excluded like
                                    as have been done in the example's main class like below.
                                    otherwise, if you use all or one of them in your application to get those features,
                                    you
                                    can provide those configurations by using default property that those dependencies
                                    provide without excluding the autoconfiguration classes.
                                </p>
                                <br>
                                <small>
                                    <span class="badge bg-primary">Updated</span>
                                    <b>payment-service >
                                        org/mono/stacksaga/example/paymentservice/PaymentServiceApplication.java
                                    </b>
                                </small>
                                <br>
                                <br>
                                <script src="https://gist.github.com/mafei-dev/8a3d50448eca24bdc678e6ede97c2c75.js"></script>

                            </div>
                        </div>


                        <br>
                        <br>

                        <p id="updating-customerpaymentrepository">
                            in order to create the endpoint to revert part of the <b>make-payment</b>, we have to update
                            the repository interface and service class and the controller class. let's go through one by
                            one starting from the repository.
                        </p>

                        <p>

                            spring boot jpa provides by default all the basic crud function when you create the
                            CrudRepository. therefore we are not going to create the update method here. instead of
                            creating that method we use the autogenerated method by spring boot. but, to the update
                            process, we should have a method to find out the relevant row by passing the <code>transactionUid</code>
                            coming from the request. to do that, we are going to create a method for that in the
                            CustomerPaymentRepository.
                        </p>

                        <br>
                        <br>
                        <small>
                            <span class="badge bg-primary">Updated</span>
                            <b>payment-service >
                                org/mono/stacksaga/example/paymentservice/repository/CustomerPaymentRepository.java
                            </b>
                        </small>
                        <script src="https://gist.github.com/mafei-dev/391b1768533c8ad885bf3d64488750ac.js"></script>


                        <br>
                        <br>
                        <p id="updating-customerpaymentservice">this is the time to create the
                            <code>makePaymentRevert</code> method and update the existing
                            payment-detail as <code>TRANSACTION_CANCELED</code>. to do that, as the 1st step find the
                            relevant data by passing the transactionUid by using the method that we created above and
                            update the payment-detail. here you can see the entire code after adding the <code>makePaymentRevert</code>
                            method.
                        </p>
                        <small>
                            <span class="badge bg-primary">Updated</span>
                            <b>payment-service >
                                org/mono/stacksaga/example/paymentservice/service/CustomerPaymentService.java
                            </b>
                        </small>
                        <script src="https://gist.github.com/mafei-dev/e80be0690cf019099903dc38a4cda97c.js"></script>
                        <br>
                        <br>

                        <p id="creating-makepaymentrevertrequestbody">now this is the time to create the
                            make-payment-revert endpoint to expose to out. before
                            creating the new method, we have to create one DTO class to use for the method (endpoint)
                            that we are
                            going to create. </p>

                        <p>let's create the <b>MakePaymentRevertRequestBody</b> Dto class. this is the class the data
                            will be converted coming from the request. it contains one filed called
                            <code>transactionId</code>. that is what we want to update existing payment-detail.
                        </p>


                        <small>
                            <span class="badge bg-primary">New</span>
                            <b>payment-service >
                                org/mono/stacksaga/example/paymentservice/dto/MakePaymentRevertRequestBody.java
                            </b>
                        </small>
                        <script src="https://gist.github.com/mafei-dev/2b280f6250fe26098389c2fdab9eb1b8.js"></script>
                        <br>


                        <p id="updating-customerpaymentcontroller">
                            now we are going to update the existing <b>CustomerPaymentController</b> class by adding new
                            method called <code>makePaymentRevert</code> as the compensation of the
                            <code>makePayment</code> by using the Dto class that we created above.
                        </p>
                        <small>
                            <span class="badge bg-primary">Updated</span>
                            <b>payment-service >
                                org/mono/stacksaga/example/paymentservice/controller/CustomerPaymentController.java
                            </b>
                        </small>
                        <script src="https://gist.github.com/mafei-dev/c37e4f3cb0055caaf81b8eee804a7abd.js"></script>
                        <br>
                        <br>

                        <p>now the application is ready to use for Saga design pattern after making those changes.</p>

                        <br>
                        <br>

                        <p>The next step is make ready the delivery-service to migrate to Saga. </p>

                    </section>


                </header>

                <div>
                    Previous <a href="./stacksaga-spring-boot-microservice-example-with-stacksaga-user-service.html"
                                target="_blank">
                    user-service - migration to Saga design pattern
                </a>
                    <br>
                    Next <a href="./stacksaga-spring-boot-microservice-example-with-stacksaga-delivery-service.html"
                            target="_blank">
                    delivery-service - migration to Saga design pattern
                </a>
                </div>

                <section class="docs-section">
                    <h2>Example series</h2>
                    <ul>
                        <li>
                            <p>
                                Microservice example without using StackSAGA (Imperative way)
                            </p>
                            <ul>

                                <li>
                                    <p>
                                        <a href="../quick-start.html" target="_blank">
                                            Introduction
                                        </a>
                                    </p>
                                </li>

                                <li>
                                    <p>
                                        <a href="../example-order-service-implementation.html" target="_blank">
                                            Implementation of order-service
                                        </a>
                                    </p>
                                </li>

                                <li>
                                    <p>
                                        <a href="../example-user-service-implementation.html" target="_blank">
                                            Implementation of eureka server
                                        </a>
                                    </p>
                                </li>
                                <li>
                                    <p>
                                        <a href="../api-cloud-gateway-implementation.html" target="_blank">
                                            Implementation of Api-gateway
                                        </a>
                                    </p>
                                </li>

                                <li>
                                    <p>
                                        <a href="../example-user-service-implementation.html" target="_blank">
                                            Implementation of user-service
                                        </a>
                                    </p>
                                </li>

                                <li>
                                    <p>
                                        <a href="../example-payment-service-implementation.html" target="_blank">
                                            Implementation of payment-service
                                        </a>
                                    </p>
                                </li>

                                <li>
                                    <p>
                                        <a href="../example-delivery-service-implementation.html" target="_blank">
                                            Implementation of delivery-service
                                        </a>
                                    </p>
                                </li>


                                <li>
                                    <p>
                                        <a href="../microservice-example-test-without-stacksaga.html" target="_blank">
                                            Final application test without using StackSaga
                                        </a>
                                    </p>
                                </li>


                            </ul>
                        </li>

                        <li>
                            <p>
                                Microservice example by using StackSAGA (Imperative way).
                            </p>
                            <ul>

                                <li>
                                    <p>
                                        <a href="./stacksaga-spring-boot-microservice-example-with-stacksaga-user-service.html"
                                           target="_blank">
                                            user-service - migration to Saga design pattern
                                        </a>
                                    </p>
                                </li>

                                <li>
                                    <p>
                                        <a href="./stacksaga-spring-boot-microservice-example-with-stacksaga-payment-service.html"
                                           target="_blank">
                                            payment-service - migration to Saga design pattern
                                        </a>
                                    </p>
                                </li>

                                <li>
                                    <p>
                                        <a href="./stacksaga-spring-boot-microservice-example-with-stacksaga-delivery-service.html"
                                           target="_blank">
                                            delivery-service - migration to Saga design pattern
                                        </a>
                                    </p>
                                </li>

                                <li>
                                    <p>
                                        <a href="./stacksaga-spring-boot-microservice-example-with-stacksaga-delivery-service.html"
                                           target="_blank">
                                            order-service - migration to Saga design pattern
                                        </a>
                                    </p>
                                </li>

                                <li>
                                    <p>
                                        <a href="./stacksaga-spring-boot-microservice-example-with-stacksaga.html"
                                           target="_blank">
                                            order-service - migration to Saga design pattern with StackSaga
                                        </a>
                                    </p>
                                </li>

                                <li>
                                    <p>
                                        <a href="./stacksaga-spring-boot-microservice-example-test-with-stacksaga.html"
                                           target="_blank">
                                            Final application using StackSaga
                                        </a>
                                    </p>
                                </li>

                            </ul>
                        </li>

                    </ul>

                </section>
            </article>

        </div>
    </div>
</div>
<!-- Javascript -->
<script src="../../../../../../assets/plugins/popper.min.js"></script>
<script src="../../../../../../assets/plugins/bootstrap/js/bootstrap.min.js"></script>


<!-- Page Specific JS -->
<script src="../../../../../../assets/plugins/smoothscroll.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/highlight.min.js"></script>
<script src="../../../../../../assets/js/highlight-custom.js"></script>
<script src="../../../../../../assets/plugins/simplelightbox/simple-lightbox.min.js"></script>
<script src="../../../../../../assets/plugins/gumshoe/gumshoe.polyfills.min.js"></script>
<script src="../../../../../../assets/js/docs.js"></script>
</body>
</html> 

